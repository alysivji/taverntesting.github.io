<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Documentation | Tavern</title>
<meta property="og:title" content="Documentation" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Automated RESTful API testing" />
<meta property="og:description" content="Automated RESTful API testing" />
<link rel="canonical" href="http://localhost:4000/documentation.html" />
<meta property="og:url" content="http://localhost:4000/documentation.html" />
<meta property="og:site_name" content="Tavern" />
<script type="application/ld+json">
{"name":null,"description":"Automated RESTful API testing","author":null,"@type":"WebPage","url":"http://localhost:4000/documentation.html","publisher":null,"image":null,"headline":"Documentation","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="description" content="Automated RESTful API testing"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <link href="https://fonts.googleapis.com/css?family=Palanquin" rel="stylesheet"> 
    <link rel="stylesheet" href="/assets/css/style.css?v=e05c691e48e0b8d49e3ccd808479ea39e13272d1">
    <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.png">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">
        <a href="/">
          <img class="beer-icon" src="/assets/icon.png">
          Tavern
        </a>
      </h1>
      <h2 class="project-tagline">Automated RESTful API testing</h2>
        <a href="/documentation" class="btn">Documentation</a>
        <a href="/examples" class="btn">Examples</a>
        <a href="https://github.com/taverntesting/tavern" class="btn">View on GitHub</a>
    </section>

    <section class="main-content">
      <h1 id="documentation">Documentation</h1>

<p>If you haven’t already, it’s worth looking through the <a href="/examples">examples</a>
before diving into this.</p>

<h2 id="contents">Contents</h2>

<ul>
  <li><a href="#anatomy-of-a-test">Anatomy of a test</a>
    <ul>
      <li><a href="#request">Request</a></li>
      <li><a href="#response">Response</a></li>
    </ul>
  </li>
  <li><a href="#calling-external-functions">Calling external functions</a>
    <ul>
      <li><a href="#built-in-validators">Built-in validators</a></li>
      <li><a href="#saving-data-with-external-functions">Saving data with external functions</a></li>
    </ul>
  </li>
  <li><a href="#anchors-between-documents">Anchors between documents</a></li>
  <li><a href="#including-external-files">Including external files</a>
    <ul>
      <li><a href="#including-external-files-via-the-command-line">Including external files via the command line</a></li>
    </ul>
  </li>
</ul>

<h2 id="anatomy-of-a-test">Anatomy of a test</h2>

<p>Tests are defined in YAML with a <strong>test_name</strong>, one or more <strong>stages</strong>, each of
which has a <strong>name</strong>, a <strong>request</strong> and a <strong>response</strong>. Taking the simple example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">test_name</span><span class="pi">:</span> <span class="s">Get some fake data from the JSON placeholder API</span>

<span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make sure we have the right ID</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">https://jsonplaceholder.typicode.com/posts/1</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">GET</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">1</span>
      <span class="na">save</span><span class="pi">:</span>
        <span class="na">body</span><span class="pi">:</span>
          <span class="na">returned_id</span><span class="pi">:</span> <span class="s">id</span>
</code></pre></div></div>

<p>If using the pytest plugin (the recommended way of using Tavern), this needs to
be in a file called <code class="highlighter-rouge">test_x.tavern.yaml</code>, where <code class="highlighter-rouge">x</code> is a description of the
contained tests.</p>

<p><strong>test_name</strong> is, as expected, the name of that test. If the pytest plugin is
being used to run integration tests, this is what the test will show up as in
the pytest report, for example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tests/integration/test_simple.tavern.yaml::Get some fake data from the JSON placeholder API
</code></pre></div></div>

<p>This can then be selected with the <code class="highlighter-rouge">-k</code> flag to pytest - e.g. pass <code class="highlighter-rouge">pytest -k fake</code>
to run all tests with ‘fake’ in the name.</p>

<p><strong>stages</strong> is a list of the stages that make up the test. A simple test might
just be to check that an endpoint returns a 401 with no login information. A
more complicated one might be:</p>

<ol>
  <li>Log in to server
    <ul>
      <li><code class="highlighter-rouge">POST</code> login information in body</li>
      <li>Expect login details to be returned in body</li>
    </ul>
  </li>
  <li>Get user information
    <ul>
      <li><code class="highlighter-rouge">GET</code> with login information in <code class="highlighter-rouge">Authorization</code> header</li>
      <li>Expect user information returned in body</li>
    </ul>
  </li>
  <li>Create a new resource with that user information
    <ul>
      <li><code class="highlighter-rouge">POST</code> with login information in <code class="highlighter-rouge">Authorization</code> header and user information in body</li>
      <li>Expect a 201 with the created resource in the body</li>
    </ul>
  </li>
  <li>Make sure it’s stored on the server
    <ul>
      <li><code class="highlighter-rouge">GET</code> with login information in <code class="highlighter-rouge">Authorization</code> header</li>
      <li>Expect the same information returned as in the previous step</li>
    </ul>
  </li>
</ol>

<p>The <strong>name</strong> of each stage is a description of what is happening in that
particular test.</p>

<h3 id="request">Request</h3>

<p>The <strong>request</strong> describes what will be sent to the server. The keys for this are
passed directly to the
<a href="http://docs.python-requests.org/en/master/api/#requests.request">requests</a>
library (after preprocessing) - at the moment the only supported keys are:</p>

<ul>
  <li><code class="highlighter-rouge">url</code> - a string, including the protocol, of the address of the server that
will be queried</li>
  <li><code class="highlighter-rouge">json</code> - a mapping of (possibly nested) key: value pairs/lists that will be
converted to JSON and sent as the request body.</li>
  <li><code class="highlighter-rouge">params</code> - a mapping of key: value pairs that will go into the query
parameters.</li>
  <li><code class="highlighter-rouge">data</code> - a mapping of key: value pairs that will go into the body as
application/x-www-url-formencoded data.</li>
  <li><code class="highlighter-rouge">headers</code> - a mapping of key: value pairs that will go into the headers. Defaults
to adding a <code class="highlighter-rouge">content-type: application/json</code> header.</li>
  <li><code class="highlighter-rouge">method</code> - one of GET, POST, PUT, or DELETE. Defaults to GET if not defined</li>
</ul>

<p>For more information, refer to the <a href="http://docs.python-requests.org/en/master/api/#requests.request">requests
documentation</a>.</p>

<h3 id="response">Response</h3>

<p>The <strong>response</strong> describes what we expect back. There are a few keys for verifying
the response:</p>

<ul>
  <li><code class="highlighter-rouge">status_code</code> - an integer corresponding to the status code that we expect.
Defaults to <code class="highlighter-rouge">200</code> if not defined.</li>
  <li><code class="highlighter-rouge">body</code> - Assuming the response is json, check the body against the values
given. Expects a mapping (possibly nested) key: value pairs/lists.
This can also use an external check function, described further down.</li>
  <li><code class="highlighter-rouge">headers</code> - a mapping of key: value pairs that will be checked against the
headers.</li>
  <li><code class="highlighter-rouge">redirect_query_params</code> - Checks the query parameters of a redirect url passed
in the <code class="highlighter-rouge">location</code> header (if one is returned). Expects a mapping of key: value
pairs. This can be useful for testing implementation of an OpenID connect
provider, where information about the request may be returned in redirect
query parameters.</li>
</ul>

<p>The <strong>save</strong> block can save values from the response for use in future requests.
Things can be saved from the body, headers, or redirect query parameters. When
used to save something from the json body, this can also access dictionaries
and lists recursively. If the response is:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"thing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"nested"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>This can be saved into the value <code class="highlighter-rouge">first_val</code> with this response block:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">response</span><span class="pi">:</span>
  <span class="na">save</span><span class="pi">:</span>
    <span class="na">body</span><span class="pi">:</span>
      <span class="na">fourth_val</span><span class="pi">:</span> <span class="s">thing.nested.0</span>
</code></pre></div></div>

<p>It is also possible to save data using function calls, explained below.</p>

<p>For a more formal definition of the schema that the tests are validated against,
check <code class="highlighter-rouge">tavern/schemas/tests.schema.yaml</code> in the main Tavern repository.</p>

<h2 id="calling-external-functions">Calling external functions</h2>

<p>Not every response can be validated simply by checking the values of keys, so with
Tavern you can call external functions to validate responses and save decoded data.
You can write your own functions or use those built in to Tavern. Each function
should take the response as its first argument, and you can pass extra arguments
using the <strong>extra_kwargs</strong> key.</p>

<h3 id="built-in-validators">Built-in validators</h3>

<p>There are two external functions built in to Tavern: <code class="highlighter-rouge">validate_jwt</code> and
<code class="highlighter-rouge">validate_pykwalify</code>.</p>

<p><code class="highlighter-rouge">validate_jwt</code> takes the key of the returned JWT in the body as <code class="highlighter-rouge">jwt_key</code>, and
additional arguments that are passed directly to the <code class="highlighter-rouge">decode</code> method in the
<a href="https://github.com/jpadilla/pyjwt/blob/master/jwt/api_jwt.py#L59">PyJWT</a>
library. <strong>NOTE: Make sure the keyword arguments you are passing are correct
or PyJWT will silently ignore them. In thr future, this function will likely be
changed to use a different library to avoid this issue.</strong></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make sure the response contains a key called 'token', the value of which is a</span>
<span class="c1"># valid jwt which is signed by the given key.</span>
<span class="na">response</span><span class="pi">:</span>
  <span class="na">body</span><span class="pi">:</span>
    <span class="s">$ext</span><span class="pi">:</span>
      <span class="na">function</span><span class="pi">:</span> <span class="s">tavern.testutils.helpers:validate_jwt</span>
      <span class="na">extra_kwargs</span><span class="pi">:</span>
        <span class="na">jwt_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">token"</span>
        <span class="na">key</span><span class="pi">:</span> <span class="s">CGQgaG7GYvTcpaQZqosLy4</span>
        <span class="na">options</span><span class="pi">:</span>
          <span class="na">verify_signature</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">verify_aud</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">validate_pykwalify</code> takes a
<a href="http://pykwalify.readthedocs.io/en/master/">pykwalify</a> schema and verifies the
body of the response against it.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make sure the response matches the given schema - a sequence of dictionaries,</span>
<span class="c1"># which has to contain a user name and may contain a user number.</span>
<span class="na">response</span><span class="pi">:</span>
  <span class="na">body</span><span class="pi">:</span>
    <span class="s">$ext</span><span class="pi">:</span>
      <span class="na">function</span><span class="pi">:</span> <span class="s">tavern.testutils.helpers:validate_pykwalify</span>
      <span class="na">extra_kwargs</span><span class="pi">:</span>
        <span class="na">schema</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">seq</span>
          <span class="na">required</span><span class="pi">:</span> <span class="s">True</span>
          <span class="na">sequence</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">map</span>
            <span class="na">mapping</span><span class="pi">:</span>
              <span class="na">user_number</span><span class="pi">:</span>
                <span class="na">type</span><span class="pi">:</span> <span class="s">int</span>
                <span class="na">required</span><span class="pi">:</span> <span class="s">False</span>
              <span class="na">user_name</span><span class="pi">:</span>
                <span class="na">type</span><span class="pi">:</span> <span class="s">str</span>
                <span class="na">required</span><span class="pi">:</span> <span class="s">True</span>
</code></pre></div></div>

<h3 id="saving-data-with-external-functions">Saving data with external functions</h3>

<p>An external function can also be used to save data from the response. To do this,
the function must return a dict where each key either points to a single value or
to an object which is accessible using dot notation. The easiest way to do this
is to return a <a href="https://pypi.python.org/pypi/python-box/">Box</a> object. Each key in
the returned object will be saved as if it had been specified separately in the 
<strong>save</strong> object. The function is called in the same way as a validator function,
in the <strong>$ext</strong> key of the <strong>save</strong> object.</p>

<p>For example, consider a function which returns the dict <code class="highlighter-rouge">{ 'a': 'value' }</code> and a
<strong>save</strong> object which look like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>save:
  body:
    $ext:
      function: utils:test_function
    b: user.id 
</code></pre></div></div>

<p>In this case, both <code class="highlighter-rouge">{a}</code> and <code class="highlighter-rouge">{b}</code> are available for use in later requests.</p>

<p>For a more practical example, the built in <code class="highlighter-rouge">validate_jwt</code> function also returns the 
decoded token as a dictionary wrapped in a <a href="https://pypi.python.org/pypi/python-box/">Box</a> 
object, which allows dot-notation access to members. This means that the contents of the
token can be used for future requests.</p>

<p>For example, if our server saves the user ID in the ‘sub’ field of the JWT:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">login</span>
  <span class="na">request</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">http://server.com/login</span>
    <span class="na">json</span><span class="pi">:</span>
      <span class="na">username</span><span class="pi">:</span> <span class="s">test_user</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">abc123</span>
  <span class="na">response</span><span class="pi">:</span>
    <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
    <span class="na">body</span><span class="pi">:</span>
      <span class="c1"># make sure a token exists</span>
      <span class="s">$ext</span><span class="pi">:</span>
        <span class="na">function</span><span class="pi">:</span> <span class="s">tavern.testutils.helpers:validate_jwt</span>
        <span class="na">extra_kwargs</span><span class="pi">:</span>
          <span class="na">jwt_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">token"</span>
          <span class="na">options</span><span class="pi">:</span>
            <span class="na">verify_signature</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">save</span><span class="pi">:</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="c1"># Saves a jwt token returned as 'token' in the body as 'jwt'</span>
        <span class="c1"># in the test configuration for use in future tests</span>
        <span class="s">$ext</span><span class="pi">:</span>
          <span class="na">function</span><span class="pi">:</span> <span class="s">tavern.testutils.helpers:validate_jwt</span>
          <span class="na">extra_kwargs</span><span class="pi">:</span>
            <span class="na">jwt_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">token"</span>
            <span class="na">options</span><span class="pi">:</span>
              <span class="na">verify_signature</span><span class="pi">:</span> <span class="no">false</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Get user information</span>
  <span class="na">request</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://server.com/info/{jwt.sub}"</span>
    <span class="s">...</span>
  <span class="na">response</span><span class="pi">:</span>
    <span class="s">...</span>
</code></pre></div></div>

<p>Ideas for other helper functions which might be useful:</p>

<ul>
  <li>Making sure that the response matches a database schema</li>
  <li>Making sure that an error returns the correct error text in the body</li>
  <li>Decoding base64 data to extract some information for use in a future query</li>
  <li>Validate templated HTML returned from an endpoint using an XML parser</li>
  <li>etc.</li>
</ul>

<h2 id="resuing-requests-and-yaml-fragments">Resuing requests and YAML fragments</h2>

<p>A lot of tests will require using the same step multiple times, such as logging
in to a server before running tests or simply running the same request twice in
a row to make sure the same (or a different) response is returned.</p>

<p>Anchors are a feature of YAML which allows you to reuse parts of the code. Define
an anchor using  <code class="highlighter-rouge">&amp;name_of_anchor</code>. This can then be assigned to another object
using <code class="highlighter-rouge">new_object: *name_or_anchor</code>, or they can be used to extend objects using
<code class="highlighter-rouge">&lt;&lt;: *name_of_anchor</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># input.yaml</span>
<span class="nn">---</span>
<span class="na">first</span><span class="pi">:</span> <span class="nl">&amp;top_anchor</span>
  <span class="na">a</span><span class="pi">:</span> <span class="s">b</span>
  <span class="na">c</span><span class="pi">:</span> <span class="s">d</span>

<span class="na">second</span><span class="pi">:</span> <span class="nv">*top_anchor</span>

<span class="na">third</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*top_anchor</span>
  <span class="na">c</span><span class="pi">:</span> <span class="s">overwritten</span>
  <span class="na">e</span><span class="pi">:</span> <span class="s">f</span>
</code></pre></div></div>

<p>If we convert this to JSON, for example with a script like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>

<span class="c"># load.py</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"input.yaml"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">yfile</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yfile</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
</code></pre></div></div>

<p>We get the following JSON:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  'first': {
    'a': 'b',
    'c': 'd'
  },
  'second': {
    'a': 'b',
    'c': 'd'
  },
  'third': {
    'a': 'b',
    'c': 'overwritten',
    'e': 'f'
  }
}
</code></pre></div></div>

<p>This does not however work if there are different documents in the yaml file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># input.yaml</span>
<span class="nn">---</span>
<span class="na">top</span><span class="pi">:</span> <span class="nl">&amp;top_anchor</span>
  <span class="na">a</span><span class="pi">:</span> <span class="s">b</span>
  <span class="na">c</span><span class="pi">:</span> <span class="s">d</span>
  <span class="na">e</span><span class="pi">:</span> <span class="s">f</span>

<span class="nn">---</span>

<span class="na">bottom</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*top_anchor</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python test.py
Traceback (most recent call last):
  File "test.py", line 4, in &lt;module&gt;
    print(yaml.load(yfile.read()))
  File "/home/michael/.virtualenvs/tavern/lib/python3.5/site-packages/yaml/__init__.py", line 72, in load
    return loader.get_single_data()
  File "/home/michael/.virtualenvs/tavern/lib/python3.5/site-packages/yaml/constructor.py", line 35, in get_single_data
    node = self.get_single_node()
  File "/home/michael/.virtualenvs/tavern/lib/python3.5/site-packages/yaml/composer.py", line 43, in get_single_node
    event.start_mark)
yaml.composer.ComposerError: expected a single document in the stream
  in "&lt;unicode string&gt;", line 3, column 1:
    top: &amp;top_anchor
    ^
but found another document
  in "&lt;unicode string&gt;", line 8, column 1:
    ---
    ^
</code></pre></div></div>

<p>This poses a bit of a problem for running our integration tests. If we want to
log in at the beginning of each test, or if we want to query some user
information which is then operated on for each test, we don’t want to copy paste
the same code within the same file.</p>

<p>For this reason, Tavern will override the default YAML behaviour and preserve anchors
across documents <strong>within the same file</strong>. Then we can do something more like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">test_name</span><span class="pi">:</span> <span class="s">Make sure user location is correct</span>

<span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="nl">&amp;test_user_login_anchor</span>
    <span class="c1"># Log in as user and save the login token for future requests</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Login as test user</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">http://test.server.com/user/login</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">GET</span>
      <span class="na">json</span><span class="pi">:</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">test_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">abc123</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
      <span class="na">save</span><span class="pi">:</span>
        <span class="na">body</span><span class="pi">:</span>
          <span class="na">test_user_login_token</span><span class="pi">:</span> <span class="s">token</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="s">$ext</span><span class="pi">:</span>
          <span class="na">function</span><span class="pi">:</span> <span class="s">tavern.testutils.helpers:validate_jwt</span>
          <span class="na">extra_kwargs</span><span class="pi">:</span>
            <span class="na">jwt_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">token"</span>
            <span class="na">options</span><span class="pi">:</span>
              <span class="na">verify_signature</span><span class="pi">:</span> <span class="no">false</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Get user location</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">http://test.server.com/locations</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">GET</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">Authorization</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{test_user_login_token}"</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
      <span class="na">body</span><span class="pi">:</span>
    <span class="na">location</span><span class="pi">:</span>
          <span class="na">road</span><span class="pi">:</span> <span class="s">123 Fake Street</span>
          <span class="na">country</span><span class="pi">:</span> <span class="s">England</span>

<span class="nn">---</span>
<span class="na">test_name</span><span class="pi">:</span> <span class="s">Make sure giving premium works</span>

<span class="na">stages</span><span class="pi">:</span>
  <span class="c1"># Use the same block to log in across documents</span>
  <span class="pi">-</span> <span class="nv">*test_user_login_anchor</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Assert user does not have premium</span>
    <span class="na">request</span><span class="pi">:</span> <span class="nl">&amp;has_premium_request_anchor</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">http://test.server.com/user_info</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">GET</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">Authorization</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{test_user_login_token}"</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="na">has_premium</span><span class="pi">:</span> <span class="no">false</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Give user premium</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">http://test.server.com/premium</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">Authorization</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{test_user_login_token}"</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Assert user now has premium</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="c1"># Use the same block within one document</span>
      <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*has_premium_request_anchor</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="na">has_premium</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<h2 id="including-external-files">Including external files</h2>

<p>Even with being able to use anchors within the same file, there is often some
data which either you want to keep in a separate (possibly autogenerated) file,
or is used on every test (e.g. login information). You might also want to run the
same tests with different sets of input data.</p>

<p>Because of this, external files can also be included which contain simple
key: value data to be used in other tests.</p>

<p>Including a file in every test can be done by using a <code class="highlighter-rouge">!include</code> directive:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># includes.yaml</span>
<span class="nn">---</span>

<span class="c1"># Each file should have a name and description</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">Common test information</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">Login information for test server</span>

<span class="c1"># Variables should just be a mapping of key: value pairs</span>
<span class="na">variables</span><span class="pi">:</span>
  <span class="na">protocol</span><span class="pi">:</span> <span class="s">https</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">www.server.com</span>
  <span class="na">port</span><span class="pi">:</span> <span class="s">1234</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tests.tavern.yaml</span>
<span class="nn">---</span>
<span class="na">test_name</span><span class="pi">:</span> <span class="s">Check server is up</span>

<span class="na">includes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="kt">!include</span> <span class="s">includes.yaml</span>

<span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Check healthz endpoint</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">GET</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{protocol:s}://{host:s}:{port:d}"</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
</code></pre></div></div>

<p>As long as includes.yaml is in the same folder as the tests, the variables will
automatically be loaded and available for formatting as before. Multiple include
files can be specified.</p>

<h3 id="including-external-files-via-the-command-line">Including external files via the command line</h3>

<p>If you do want to run the same tests with a different input data, this can be
achieved by passing in a global configuration.</p>

<p>Using the <code class="highlighter-rouge">tavern-ci</code> tool or pytest, this can be passed in at the command line
using the <code class="highlighter-rouge">--tavern-global-cfg</code> flag. The file given will be loaded and used as
before.</p>


      <footer class="site-footer">
        <span class="site-footer-owner">
          <a href="https://github.com/taverntesting/tavern">Tavern</a> is maintained by <a href="https://overlock.io">Overlock</a>.
        </span>
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </section>

    
  </body>
</html>