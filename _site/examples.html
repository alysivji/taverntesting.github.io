<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Examples | Tavern</title>
<meta property="og:title" content="Examples" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Automated RESTful API testing" />
<meta property="og:description" content="Automated RESTful API testing" />
<link rel="canonical" href="http://localhost:4000/examples.html" />
<meta property="og:url" content="http://localhost:4000/examples.html" />
<meta property="og:site_name" content="Tavern" />
<script type="application/ld+json">
{"name":null,"description":"Automated RESTful API testing","author":null,"@type":"WebPage","url":"http://localhost:4000/examples.html","publisher":null,"image":null,"headline":"Examples","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="description" content="Automated RESTful API testing"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <link href="https://fonts.googleapis.com/css?family=Palanquin" rel="stylesheet"> 
    <link rel="stylesheet" href="/assets/css/style.css?v=1997c00e741f3e550ba277b840631a237df58947">
    <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.png">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">
        <a href="/">
          <img class="beer-icon" src="/assets/icon.png">
          Tavern
        </a>
      </h1>
      <h2 class="project-tagline">Automated RESTful API testing</h2>
        <a href="/documentation" class="btn">Documentation</a>
        <a href="/examples" class="btn">Examples</a>
        <a href="https://github.com/taverntesting/tavern" class="btn">View on GitHub</a>
    </section>

    <section class="main-content">
      <h1 id="examples">Examples</h1>

<h2 id="1-the-simplest-possible-test">1) The simplest possible test</h2>

<p>To show you just how simple a Tavern test can be, here’s one which uses the JSON Placeholder API at <a href="https://jsonplaceholder.typicode.com/">jsonplaceholder.typicode.com</a>. To try it, create a new file called <code class="highlighter-rouge">minimal_test.tavern.yaml</code> with the following:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">block_name</span><span class="pi">:</span> <span class="s">Get some fake data from the JSON placeholder API</span>

<span class="na">tests</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make sure we have the right ID</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">https://jsonplaceholder.typicode.com/posts/1</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">GET</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">1</span>
</code></pre></div></div>

<p>In most circumstances you will be using Tavern with pytest but for now you can run it using the Tavern command-line interface, <code class="highlighter-rouge">tavern-ci</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tavern-ci <span class="nt">--in-file</span> minimal.tavern.yaml
</code></pre></div></div>

<h2 id="2-testing-a-simple-server">2) Testing a simple server</h2>

<p>In this example we will create a server with a single route which doubles any number you pass it, and write some simple tests for it. You’ll see how simple the YAML-based syntax can be, and the three different ways you can run Tavern tests.</p>

<p>Here’s what such a server might look like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># server.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">"/double"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">double_number</span><span class="p">():</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s">"number"</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="nb">KeyError</span><span class="p">,</span> <span class="nb">TypeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"error"</span><span class="p">:</span> <span class="s">"no number passed"</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">double</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"error"</span><span class="p">:</span> <span class="s">"a number was not passed"</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">"double"</span><span class="p">:</span> <span class="n">double</span><span class="p">}),</span> <span class="mi">200</span>
</code></pre></div></div>

<p>Run the server using Flask:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">FLASK_APP</span><span class="o">=</span>server.py
<span class="nv">$ </span>flask run
</code></pre></div></div>

<p>There are two key things to test here: first, that it successfully doubles numbers and second, that it returns the correct error codes and messages. To do this we will write two ‘blocks’, one for the success case and one for the error case. Each block can contain one or more tests, and each test has a name, a request and an expected response.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_server.tavern.yaml</span>

<span class="nn">---</span>

<span class="na">block_name</span><span class="pi">:</span> <span class="s">Make sure server doubles number properly</span>

<span class="na">tests</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make sure number is returned correctly</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">http://localhost:5000/double</span>
      <span class="na">json</span><span class="pi">:</span>
        <span class="na">number</span><span class="pi">:</span> <span class="s">5</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">content-type</span><span class="pi">:</span> <span class="s">application/json</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="na">double</span><span class="pi">:</span> <span class="s">10</span>

<span class="nn">---</span>

<span class="na">block_name</span><span class="pi">:</span> <span class="s">Check invalid inputs are handled</span>

<span class="na">tests</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make sure invalid numbers don't cause an error</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">http://localhost:5000/double</span>
      <span class="na">json</span><span class="pi">:</span>
        <span class="na">number</span><span class="pi">:</span> <span class="s">dkfsd</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">content-type</span><span class="pi">:</span> <span class="s">application/json</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">400</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="na">error</span><span class="pi">:</span> <span class="s">a number was not passed</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make sure it raises an error if a number isn't passed</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">http://localhost:5000/double</span>
      <span class="na">json</span><span class="pi">:</span>
        <span class="na">wrong_key</span><span class="pi">:</span> <span class="s">5</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">content-type</span><span class="pi">:</span> <span class="s">application/json</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">400</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="na">error</span><span class="pi">:</span> <span class="s">no number passed</span>
</code></pre></div></div>

<p>The tests can be run in three different ways: from Python code, from the command line, or with pytest. The most common way is to use pytest. All three require Tavern to be installed.</p>

<p>If you run pytest in a folder containing <code class="highlighter-rouge">test_server.tavern.yaml</code> it will automatically find the file and run the tests. Otherwise, you will need to point it to the folder containing the integration tests or add it to <code class="highlighter-rouge">setup.cfg/tox.ini/etc</code> so that Pytest’s collection mechanism knows where to look.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>py.test
<span class="o">=============================</span> <span class="nb">test </span>session starts <span class="o">==============================</span>
platform linux <span class="nt">--</span> Python 3.5.2, pytest-3.2.0, py-1.4.34, pluggy-0.4.0
rootdir: /home/developer/project/tests, inifile: setup.cfg
plugins: tavern-0.0.1
collected 4 items 

test_server.tavern.yaml ..

<span class="o">=====================</span> 2 passed, 2 skipped <span class="k">in </span>0.07 seconds <span class="o">======================</span>
</code></pre></div></div>

<p>The Python library allows you to include Tavern tests in deploy scripts written in Python, or for use with a continuous integration setup:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">tavern.core</span> <span class="kn">import</span> <span class="n">run</span>

<span class="n">success</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">"test_server.tavern.yaml"</span><span class="p">,</span> <span class="p">{})</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Error running tests"</span><span class="p">)</span>
</code></pre></div></div>

<p>The command line tool is useful for bash scripting, for example if you want to verify that an API is works before deploying it, or for cron jobs.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tavern-ci <span class="nt">--in-file</span> test_server.tavern.yaml
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$?</span>
0
</code></pre></div></div>

<h2 id="3-multi-step-tests">3) Multi-step tests</h2>

<p>The final example uses a more complex test server which requires the user to log in, save the token it returns and use it for all future requests. It also has a simple database so we can check that data we send to it is successfully returned.</p>

<p><a href="/server">Here is the example server we will be using.</a></p>

<p>To test this behaviour we can use multiple tests in a row, keeping track of variables between them, and ensuring the server state has been updated as expected.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">block_name</span><span class="pi">:</span> <span class="s">Make sure server saves and returns a number correctly</span>

<span class="na">tests</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">login</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">http://localhost:5000/login</span>
      <span class="na">json</span><span class="pi">:</span>
        <span class="na">user</span><span class="pi">:</span> <span class="s">test-user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">correct-password</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">content-type</span><span class="pi">:</span> <span class="s">application/json</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="s">$validate_function</span><span class="pi">:</span>
          <span class="na">function</span><span class="pi">:</span> <span class="s">tavern.util.validators:validate_jwt</span>
          <span class="na">extra_kwargs</span><span class="pi">:</span>
            <span class="na">jwt_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">token"</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">CGQgaG7GYvTcpaQZqosLy4</span>
            <span class="na">options</span><span class="pi">:</span>
              <span class="na">verify_signature</span><span class="pi">:</span> <span class="no">true</span>
              <span class="na">verify_aud</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">content-type</span><span class="pi">:</span> <span class="s">application/json</span>
      <span class="na">save</span><span class="pi">:</span>
        <span class="na">body</span><span class="pi">:</span>
          <span class="na">test_login_token</span><span class="pi">:</span> <span class="s">token</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">post a number</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">http://localhost:5000/numbers</span>
      <span class="na">json</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">smallnumber</span>
        <span class="na">number</span><span class="pi">:</span> <span class="s">123</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">content-type</span><span class="pi">:</span> <span class="s">application/json</span>
        <span class="na">Authorization</span><span class="pi">:</span> <span class="s2">"</span><span class="s">bearer</span><span class="nv"> </span><span class="s">{test_login_token:s}"</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">201</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="pi">{}</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">content-type</span><span class="pi">:</span> <span class="s">application/json</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make sure its in the db</span>
    <span class="na">request</span><span class="pi">:</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">http://localhost:5000/numbers</span>
      <span class="na">params</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">smallnumber</span>
      <span class="na">method</span><span class="pi">:</span> <span class="s">GET</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">content-type</span><span class="pi">:</span> <span class="s">application/json</span>
        <span class="na">Authorization</span><span class="pi">:</span> <span class="s2">"</span><span class="s">bearer</span><span class="nv"> </span><span class="s">{test_login_token:s}"</span>
    <span class="na">response</span><span class="pi">:</span>
      <span class="na">status_code</span><span class="pi">:</span> <span class="s">200</span>
      <span class="na">body</span><span class="pi">:</span>
        <span class="na">number</span><span class="pi">:</span> <span class="s">123</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">content-type</span><span class="pi">:</span> <span class="s">application/json</span>
</code></pre></div></div>

<p>This example illustrates three major parts of the Tavern syntax: saving data, using that data in later requests and using validation functions.</p>

<h3 id="saving-data-for-later-requests">Saving data for later requests</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">response</span><span class="pi">:</span>
  <span class="na">save</span><span class="pi">:</span>
    <span class="na">body</span><span class="pi">:</span>
      <span class="s">&lt;variable name&gt;</span><span class="pi">:</span> <span class="s">&lt;value to assign&gt;</span>
</code></pre></div></div>

<p>To save a piece of data returned from an API call, use the <code class="highlighter-rouge">save</code> key in the response object. For each piece of data you want to save, you have to specify which part of the response you want to save by passing the key name and what you want to refer to the variable as in later tests. You can save data from the <code class="highlighter-rouge">body</code>, <code class="highlighter-rouge">headers</code>.</p>

<p>This example assigns the value of <code class="highlighter-rouge">body.token</code> to the variable <code class="highlighter-rouge">test_login_token</code> and the redirect location to <code class="highlighter-rouge">next_redirect_location</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">save</span><span class="pi">:</span>
  <span class="na">body</span><span class="pi">:</span>
    <span class="na">test_login_token</span><span class="pi">:</span> <span class="s">token</span>
  <span class="na">headers</span><span class="pi">:</span>
    <span class="na">next_redirect_location</span><span class="pi">:</span> <span class="s">location</span>
</code></pre></div></div>

<h3 id="using-saved-data">Using saved data</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">&lt;key&gt;</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">&lt;variable name&gt;</span><span class="pi">:</span><span class="nv">&lt;type code&gt;</span><span class="pi">}</span>
</code></pre></div></div>

<p>Saved data can be used in later tests using Python’s <a href="https://docs.python.org/2/library/string.html#format-string-syntax">string formatting syntax</a>. The variable to be used is encased in curly brackets and an optional <a href="https://docs.python.org/2/library/string.html#format-specification-mini-language">type code</a> can be passed after a colon</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">headers</span><span class="pi">:</span>
  <span class="na">Authorization</span><span class="pi">:</span> <span class="s2">"</span><span class="s">bearer</span><span class="nv"> </span><span class="s">{test_login_token:s}"</span>
</code></pre></div></div>

<h3 id="validation-functions">Validation functions</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">response</span><span class="pi">:</span>
  <span class="na">body</span><span class="pi">:</span>
    <span class="s">$validate_function</span><span class="pi">:</span>
      <span class="na">function</span><span class="pi">:</span> <span class="s">&lt;path to module&gt;:&lt;name of function&gt;</span>
      <span class="na">extra_kwargs</span><span class="pi">:</span>
        <span class="s">&lt;key&gt;</span><span class="pi">:</span> <span class="s">&lt;value&gt;</span>
        <span class="s">&lt;key&gt;</span><span class="pi">:</span>
          <span class="s">&lt;nested key&gt;</span><span class="pi">:</span> <span class="s">&lt;value&gt;</span>
          <span class="s">&lt;nested key&gt;</span><span class="pi">:</span> <span class="s">&lt;value&gt;</span>
</code></pre></div></div>

<p>To use a validation function, add it to the response body inside a <code class="highlighter-rouge">$validate_function</code> key. You must specify the path to the module containing the function (for example, all built-in validation functions are located at <code class="highlighter-rouge">tavern.util.validators</code>) and the name of the function in the <code class="highlighter-rouge">function</code> key.</p>

<p>The first argument of every validation function is the response, and further arguments can be passed in by defining them in <code class="highlighter-rouge">extra_kwargs</code>.</p>

<p>There are two validation functions built in to Tavern: <code class="highlighter-rouge">validate_jwt</code> and <code class="highlighter-rouge">validate_pykwalify</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># validate_jwt example</span>
<span class="s">$validate_function</span><span class="pi">:</span>
  <span class="na">function</span><span class="pi">:</span> <span class="s">tavern.util.validators:validate_jwt</span>
  <span class="na">extra_kwargs</span><span class="pi">:</span>
    <span class="na">jwt_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">token"</span>
    <span class="na">key</span><span class="pi">:</span> <span class="s">CGQgaG7GYvTcpaQZqosLy4</span>
    <span class="na">options</span><span class="pi">:</span>
      <span class="na">verify_signature</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">verify_aud</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<h2 id="further-reading">Further reading</h2>

<p>For more detailed information on how to use Tavern and how it works, take a look at the <a href="/documentation">documentation</a>. To see the source code, suggest improvements or even contribute a pull request check out the <a href="https://github.com/taverntesting/tavern">GitHub repository</a>.</p>


      <footer class="site-footer">
        <span class="site-footer-owner">
          <a href="https://github.com/taverntesting/tavern">Tavern</a> is maintained by <a href="https://overlock.io">Overlock</a>.
        </span>
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </section>

    
  </body>
</html>